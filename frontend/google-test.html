<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediReminder OAuth</title>
    <script src="https://accounts.google.com/gsi/client" async defer onload="window.googleReady = true;"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./google-test.css?v=20260206">
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="logo-icon">üîê</div>
            <h1>MediReminder OAuth</h1>
            <p>Secure Google account sign-in for your medication reminders.</p>
        </header>

        <main class="card">
            <div class="trust-strip" aria-label="Security indicators">
                <span>üîí OAuth 2.0</span>
                <span>‚úÖ Google Identity</span>
                <span>üõ°Ô∏è Secure Tokens</span>
            </div>

            <section class="steps-container">
                <div class="step-item">
                    <div class="step-badge">1</div>
                    <div class="step-text">
                        <h3>Authenticate with Google</h3>
                        <p>Sign in with your Google account to link your MediReminder profile.</p>
                    </div>
                </div>

                <div class="step-item">
                    <div class="step-badge">2</div>
                    <div class="step-text">
                        <h3>Issue secure session tokens</h3>
                        <p>Backend validates identity and returns access and refresh tokens.</p>
                    </div>
                </div>

                <div class="step-item">
                    <div class="step-badge">3</div>
                    <div class="step-text">
                        <h3>Enable reminder actions</h3>
                        <p>Activate push notifications and process quick actions from reminder links.</p>
                    </div>
                </div>
            </section>

            <div class="signin-area">
                <div class="signin-content">
                    <h2>Continue with Google</h2>
                    <p>Sign in to connect your account and enable personalized reminders.</p>
                    <div id="buttonDiv"></div>
                </div>
            </div>

            <div id="result" class="result-area hidden">
                <div id="resultContent"></div>
            </div>
        </main>

        <footer class="app-footer">
            <p>üíä MediReminder API v1.0 ‚Ä¢ Production Environment</p>
        </footer>
    </div>

    <script>
        // ===== Runtime configuration & shared UI state =====
        const BACKEND_URL = 'https://medication-reminder-api.onrender.com';
        let API_URL = `${BACKEND_URL}/auth/google`;
        let currentAccessToken = localStorage.getItem('medi_token') || null;
        let pendingNotificationAction = null;

        // Registers FCM service worker from site root.
        // Firebase messaging requires root scope for reliable foreground/background delivery.
        async function registerRootServiceWorker() {
            const swPath = '/firebase-messaging-sw.js';

            const swCheck = await fetch(swPath, { cache: 'no-store' });
            if (!swCheck.ok) {
                throw new Error('Service worker must be served from site root at /firebase-messaging-sw.js');
            }

            const registration = await navigator.serviceWorker.register(swPath, { scope: '/' });
            if (!registration.scope.startsWith(`${window.location.origin}/`)) {
                throw new Error(`Unexpected service worker scope: ${registration.scope}`);
            }

            return registration;
        }

        // Renders a user-facing error when Google Sign-In fails to initialize.
        function showGoogleButtonError(message) {
            const buttonDiv = document.getElementById('buttonDiv');
            buttonDiv.innerHTML = '<div class="error-banner"><span id="googleButtonError"></span></div>';
            document.getElementById('googleButtonError').textContent = `‚ö†Ô∏è ${message}`;
        }

        // Waits for Google Identity Services script readiness.
        // Prevents timing issues before calling google.accounts.id APIs.
        function waitForGoogle() {
            return new Promise((resolve) => {
                if (window.googleReady || (window.google && window.google.accounts && window.google.accounts.id)) {
                    resolve();
                    return;
                }

                let attempts = 0;
                const checkGoogle = setInterval(() => {
                    attempts += 1;
                    if (window.googleReady || (window.google && window.google.accounts && window.google.accounts.id)) {
                        clearInterval(checkGoogle);
                        resolve();
                    } else if (attempts >= 150) {
                        clearInterval(checkGoogle);
                        console.warn('‚ö†Ô∏è Google library timeout');
                        resolve();
                    }
                }, 100);
            });
        }

        // Parses quick action from URL.
        // Supported shape: ?id=<reminder_id>&action=mark-taken
        function getNotificationActionFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const reminderId = urlParams.get('id');
            const action = urlParams.get('action');

            if (reminderId && action === 'mark-taken') {
                return { reminderId, action };
            }

            return null;
        }

        // Loads OAuth config from backend and renders Google Sign-In button.
        async function loadConfig() {
            try {
                await waitForGoogle();

                const response = await fetch(`${BACKEND_URL}/config/frontend`);
                if (!response.ok) {
                    throw new Error(`Failed to load frontend config (${response.status})`);
                }

                const config = await response.json();
                if (!config.google_client_id) {
                    throw new Error('Backend returned empty Client ID');
                }

                API_URL = `${BACKEND_URL}/auth/google`;

                google.accounts.id.initialize({
                    client_id: config.google_client_id,
                    callback: handleCredentialResponse
                });

                google.accounts.id.renderButton(document.getElementById('buttonDiv'), {
                    theme: 'outline',
                    size: 'large',
                    type: 'standard',
                    shape: 'pill',
                    text: 'continue_with',
                    width: '300'
                });
            } catch (error) {
                console.error(error);
                showGoogleButtonError(error.message);
            }
        }

        // Handles Google credential callback:
        // 1) Exchange Google ID token with backend
        // 2) Show resulting app tokens
        // 3) Process pending reminder action
        // 4) Register push notifications
        async function handleCredentialResponse(response) {
            const resultDiv = document.getElementById('result');
            const resultContent = document.getElementById('resultContent');

            resultDiv.classList.remove('hidden');
            resultContent.innerHTML = `
                <div class="status-badge loading">
                    <span class="dot"></span> Authenticating...
                </div>
            `;

            try {
                const apiResponse = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id_token: response.credential })
                });

                const data = await apiResponse.json().catch(() => ({}));

                if (apiResponse.ok) {
                    resultContent.innerHTML = `
                        <div class="status-badge success">‚úÖ Authentication Successful</div>
                        <div class="token-group">
                            <label>Access Token</label>
                            <div id="accessTokenDisplay" class="code-block"></div>
                        </div>
                        <div class="token-group">
                            <label>Refresh Token</label>
                            <div id="refreshTokenDisplay" class="code-block"></div>
                        </div>
                    `;

                    document.getElementById('accessTokenDisplay').textContent = data.access_token || '';
                    document.getElementById('refreshTokenDisplay').textContent = data.refresh_token || '';

                    currentAccessToken = data.access_token || null;
                    if (currentAccessToken) {
                        localStorage.setItem('medi_token', currentAccessToken);
                    }

                    await handleNotificationAction();
                    await setupPushNotifications(currentAccessToken);
                } else {
                    resultContent.innerHTML = `
                        <div class="status-badge error">‚ùå Authentication Failed</div>
                        <div class="error-details">
                            <strong>Error:</strong> <span id="errorDetailDisplay"></span>
                            <pre id="errorFullDisplay"></pre>
                        </div>
                    `;

                    document.getElementById('errorDetailDisplay').textContent = data.detail || 'Unknown error';
                    document.getElementById('errorFullDisplay').textContent = JSON.stringify(data, null, 2);
                }
            } catch (error) {
                resultContent.innerHTML = `
                    <div class="status-badge error">‚ùå Network Error</div>
                    <p id="networkErrorMessage"></p>
                `;
                document.getElementById('networkErrorMessage').textContent = error.message;
            }
        }

        // Sets up browser notifications and registers FCM token with backend.
        async function setupPushNotifications(accessToken) {
            const resultContent = document.getElementById('resultContent');

            resultContent.innerHTML += `
                <div class="token-group" style="margin-top: 20px;">
                    <label>üîî Push Notifications</label>
                    <div id="notificationStatus" class="status-badge loading">
                        <span class="dot"></span> Setting up...
                    </div>
                    <div id="permissionHint" style="display:none; font-size: 0.85rem; color: #666; margin-top: 5px;">
                        üí° <i>It looks like notifications are blocked. Please click the lock icon in your browser address bar to reset permissions.</i>
                    </div>
                </div>
            `;

            const notificationStatus = document.getElementById('notificationStatus');
            const permissionHint = document.getElementById('permissionHint');

            try {
                if (!accessToken) {
                    throw new Error('Missing access token for push notification setup');
                }
                if (!('Notification' in window)) {
                    throw new Error('Notifications are not supported by this browser');
                }
                if (!('serviceWorker' in navigator)) {
                    throw new Error('Service workers are not supported by this browser');
                }

                const permission = await Notification.requestPermission();
                if (permission !== 'granted') {
                    notificationStatus.className = 'status-badge error';
                    notificationStatus.textContent = '‚ùå Permission denied';
                    if (permission === 'denied') {
                        permissionHint.style.display = 'block';
                    }
                    return;
                }

                const firebaseConfig = {
                    apiKey: 'AIzaSyC9BD1eVJkmzUL2fgwnBZNT9ufLDq_MiNI',
                    authDomain: 'medication-reminder-e87a4.firebaseapp.com',
                    projectId: 'medication-reminder-e87a4',
                    storageBucket: 'medication-reminder-e87a4.firebasestorage.app',
                    messagingSenderId: '520153865045',
                    appId: '1:520153865045:web:b23af841554f088c58addc',
                    measurementId: 'G-HDR04VFTWP'
                };

                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                const messaging = firebase.messaging();

                console.log('üîî Requesting service worker...');
                const registration = await registerRootServiceWorker();

                await navigator.serviceWorker.ready;
                console.log('Service Worker is ready!');

                let retryCount = 0;
                while (!registration.active && retryCount < 10) {
                    console.log('‚è≥ Waiting for active state...');
                    await new Promise((resolve) => setTimeout(resolve, 500));
                    retryCount += 1;
                }

                console.log('‚úÖ Service Worker is ACTIVE!');

                const token = await messaging.getToken({
                    vapidKey: 'BEBbHijT6Iggstvg0wYwZ0gmcNTGkdL_SyNYEUofRlldxE6KxsF4vUGtKoGVKh_2RxT8Qu4-_JP8bC_1Rc9-IIg',
                    serviceWorkerRegistration: registration
                });

                if (!token) {
                    throw new Error('Failed to generate FCM token');
                }

                const tokenResponse = await fetch(`${BACKEND_URL}/user/fcm-token`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        Authorization: `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({ fcm_token: token })
                });

                if (!tokenResponse.ok) {
                    throw new Error(`Failed to save FCM token (${tokenResponse.status})`);
                }

                notificationStatus.className = 'status-badge success';
                notificationStatus.textContent = '‚úÖ Notifications enabled';

                messaging.onMessage((payload) => {
                    const notification = payload && payload.notification;
                    if (!notification) {
                        return;
                    }

                    console.log('üì© Notification received:', payload);
                    new Notification(notification.title || 'MediReminder', {
                        body: notification.body || '',
                        icon: '/favicon.ico'
                    });
                });
            } catch (error) {
                console.error('‚ùå Push notification setup failed:', error);
                if (notificationStatus) {
                    notificationStatus.className = 'status-badge error';
                    notificationStatus.textContent = `‚ö†Ô∏è ${error.message}`;
                }
            }
        }

        // Executes notification deep-link action after successful authentication.
        async function handleNotificationAction() {
            if (!pendingNotificationAction) {
                return;
            }

            const { reminderId, action } = pendingNotificationAction;

            if (reminderId && action === 'mark-taken') {
                console.log(`Processing ${action} for reminder: ${reminderId}`);

                if (!currentAccessToken) {
                    console.warn('‚ö†Ô∏è Action requested but no active session token found. Please login first.');
                    return;
                }

                try {
                    const response = await fetch(`${BACKEND_URL}/reminders/${reminderId}/status`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            Authorization: `Bearer ${currentAccessToken}`
                        },
                        body: JSON.stringify({ status: 'taken' })
                    });

                    if (response.ok) {
                        alert('‚úÖ Medication marked as taken!');
                        pendingNotificationAction = null;
                        window.history.replaceState({}, document.title, window.location.pathname);
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        console.error('‚ùå Failed to update status:', errorData.detail || `HTTP ${response.status}`);
                    }
                } catch (error) {
                    console.error('‚ùå Failed to update status:', error);
                }
            }
        }

        // ===== Startup sequence =====
        // Read URL action, render Google Sign-In, and attempt action processing.
        pendingNotificationAction = getNotificationActionFromUrl();
        loadConfig();
        handleNotificationAction();
    </script>
</body>
</html>
