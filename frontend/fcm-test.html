<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FCM Push Notification Setup</title>
    <link rel="stylesheet" href="fcm-test.css">
</head>
<body>
    <div class="container">
        <h1>ðŸ”” Push Notifications Setup</h1>
        <p class="subtitle">Configure Firebase Cloud Messaging for medication reminders</p>

        <!-- Step 1: Login -->
        <div class="step" id="step1">
            <div class="step-title">Step 1: Login to Your Account</div>
            <div class="step-desc">Enter your API credentials to authenticate</div>

            <div class="input-group">
                <label for="email">Email</label>
                <input type="email" id="email" placeholder="your@email.com">
            </div>

            <div class="input-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Your password">
            </div>

            <button onclick="handleLogin()">Login & Continue</button>
            <div id="loginStatus"></div>
        </div>

        <!-- Step 2: Enable Notifications -->
        <div class="step hidden" id="step2">
            <div class="step-title">Step 2: Enable Browser Notifications</div>
            <div class="step-desc">Click the button below to allow notifications. A permission popup will appear.</div>
            <button onclick="requestNotificationPermission()">Enable Notifications</button>
            <div id="permissionStatus"></div>
        </div>

        <!-- Step 3: Get FCM Token -->
        <div class="step hidden" id="step3">
            <div class="step-title">Step 3: Get Device Token</div>
            <div class="step-desc">Generate your unique device token for push notifications</div>
            <button onclick="getFCMToken()">Generate Token</button>
            <div id="tokenStatus"></div>
            <div id="tokenDisplay" class="token-box hidden"></div>
        </div>

        <!-- Step 4: Save to Backend -->
        <div class="step hidden" id="step4">
            <div class="step-title">Step 4: Save to Your Account</div>
            <div class="step-desc">Register this device with your backend server</div>
            <button onclick="saveTokenToBackend()">Save Token to Server</button>
            <div id="saveStatus"></div>
        </div>

        <!-- Step 5: Test -->
        <div class="step hidden" id="step5">
            <div class="step-title">âœ… Setup Complete!</div>
            <div class="step-desc">You're all set! You'll now receive medication reminders on this device.</div>
            <div class="status success">
                <strong>Success!</strong> Push notifications are now enabled for your account.
                <br><br>
                <strong>What's next?</strong>
                <ul style="margin-top: 10px; padding-left: 20px;">
                    <li>Keep this browser tab open to receive notifications</li>
                    <li>Create a medication schedule in the app</li>
                    <li>You'll get reminders at the scheduled times</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-messaging.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC9BD1eVJkmzUL2fgwnBZNT9ufLDq_MiNI",
            authDomain: "medication-reminder-e87a4.firebaseapp.com",
            projectId: "medication-reminder-e87a4",
            storageBucket: "medication-reminder-e87a4.firebasestorage.app",
            messagingSenderId: "520153865045",
            appId: "1:520153865045:web:b23af841554f088c58addc",
            measurementId: "G-HDR04VFTWP"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const messaging = getMessaging(app);

        // VAPID Key from Firebase Console
        const VAPID_KEY = "BEBbHijT6Iggstvg0wYwZ0gmcNTGkdL_SyNYEUofRlldxE6KxsF4vUGtKoGVKh_2RxT8Qu4-_JP8bC_1Rc9-IIg";

        // Global State
        let accessToken = null;
        let fcmToken = null;

        // (Add /api/v1 to the end of this string if your backend requires it!)
        const API_BASE = "https://medication-reminder-api.onrender.com";

        // ====================================
        // STEP 1: LOGIN

        window.handleLogin = async function() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const statusDiv = document.getElementById('loginStatus');

            if (!email || !password) {
                showStatus(statusDiv, 'Please enter both email and password', 'error');
                return;
            }

            try {
                showStatus(statusDiv, 'Logging in...', 'info');

                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        username: email,
                        password: password
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Login failed');
                }

                const data = await response.json();
                accessToken = data.access_token;

                showStatus(statusDiv, 'âœ… Login successful!', 'success');

                setTimeout(() => {
                    document.getElementById('step2').classList.remove('hidden');
                    document.getElementById('step2').scrollIntoView({ behavior: 'smooth' });
                }, 1000);

            } catch (error) {
                showStatus(statusDiv, `âŒ Login failed: ${error.message}`, 'error');
            }
        };

        // ====================================
        // STEP 2: REQUEST PERMISSION

        window.requestNotificationPermission = async function() {
            const statusDiv = document.getElementById('permissionStatus');

            try {
                showStatus(statusDiv, 'Requesting permission...', 'info');

                const permission = await Notification.requestPermission();

                if (permission === 'granted') {
                    showStatus(statusDiv, 'âœ… Permission granted!', 'success');

                    setTimeout(() => {
                        document.getElementById('step3').classList.remove('hidden');
                        document.getElementById('step3').scrollIntoView({ behavior: 'smooth' });
                    }, 1000);
                } else if (permission === 'denied') {
                    showStatus(statusDiv, 'âŒ Permission denied.', 'error');
                } else {
                    showStatus(statusDiv, 'âš ï¸ Permission dismissed.', 'error');
                }
            } catch (error) {
                showStatus(statusDiv, `âŒ Error: ${error.message}`, 'error');
            }
        };

        // ====================================
        // STEP 3: GET FCM TOKEN

        window.getFCMToken = async function() {
            const statusDiv = document.getElementById('tokenStatus');
            const tokenDisplay = document.getElementById('tokenDisplay');

            try {
                showStatus(statusDiv, 'Generating token...', 'info');

                console.log("Registering Service Worker...");
                const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
                await navigator.serviceWorker.ready;
                console.log("Service Worker is ready!");

                const token = await getToken(messaging, {
                    vapidKey: VAPID_KEY,
                    serviceWorkerRegistration: registration // Pass it to Firebase!
                });

                if (token) {
                    fcmToken = token;
                    showStatus(statusDiv, 'âœ… Token generated successfully!', 'success');

                    tokenDisplay.textContent = token;
                    tokenDisplay.classList.remove('hidden');

                    setTimeout(() => {
                        document.getElementById('step4').classList.remove('hidden');
                        document.getElementById('step4').scrollIntoView({ behavior: 'smooth' });
                    }, 1000);
                } else {
                    throw new Error('No registration token available');
                }
            } catch (error) {
                showStatus(statusDiv, `âŒ Failed to generate token: ${error.message}`, 'error');
                console.error('Token generation error:', error);
            }
        };

        // ====================================
        // STEP 4: SAVE TO BACKEND

        window.saveTokenToBackend = async function() {
            const statusDiv = document.getElementById('saveStatus');

            if (!accessToken || !fcmToken) {
                showStatus(statusDiv, 'âŒ Missing token or login.', 'error');
                return;
            }

            try {
                showStatus(statusDiv, 'Saving token to server...', 'info');

                // If you got a 405 error earlier, change 'users' to 'user' here!
                const response = await fetch(`${API_BASE}/user/fcm-token`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({ fcm_token: fcmToken })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to save token');
                }

                showStatus(statusDiv, 'âœ… Token saved successfully!', 'success');

                setTimeout(() => {
                    document.getElementById('step5').classList.remove('hidden');
                    document.getElementById('step5').scrollIntoView({ behavior: 'smooth' });
                }, 1000);

            } catch (error) {
                showStatus(statusDiv, `âŒ Failed to save token: ${error.message}`, 'error');
            }
        };

        // ====================================
        // LISTEN FOR FOREGROUND MESSAGES

        onMessage(messaging, (payload) => {
            console.log('ðŸ“© Message received:', payload);
            if (payload.notification) {
                new Notification(payload.notification.title, {
                    body: payload.notification.body,
                    icon: '/favicon.ico',
                    badge: '/badge.png'
                });
            }
        });

        function showStatus(element, message, type) {
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
    </script>
</body>
</html>
