name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Create .env file
        run: |
          touch .env
          
          # --- ðŸ”’ SECRETS (Hidden) ---
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env
          echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> .env
          echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env
          echo "MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}" >> .env
          echo "MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}" >> .env
          echo "AT_API_KEY=${{ secrets.AT_API_KEY }}" >> .env
          echo "REDIS_URL=${{ secrets.REDIS_URL }}" >> .env
          
          # --- âš™ï¸ VARIABLES (Visible) ---
          echo "ENVIRONMENT=${{ vars.ENVIRONMENT }}" >> .env
          echo "FRONTEND_URL=${{ vars.FRONTEND_URL }}" >> .env
          echo "CORS_ORIGINS=${{ vars.CORS_ORIGINS }}" >> .env
          echo "COOLDOWN_MINUTES=${{ vars.COOLDOWN_MINUTES }}" >> .env
          echo "MAIL_SERVER=${{ vars.MAIL_SERVER }}" >> .env
          echo "MAIL_PORT=${{ vars.MAIL_PORT }}" >> .env
          echo "MAIL_FROM=${{ vars.MAIL_FROM }}" >> .env
          echo "MAIL_FROM_NAME=${{ vars.MAIL_FROM_NAME }}" >> .env
          echo "MAIL_SSL_TLS=${{ vars.MAIL_SSL_TLS }}" >> .env
          echo "MAIL_STARTTLS=${{ vars.MAIL_STARTTLS }}" >> .env
          echo "MAX_ATTEMPTS_PER_EMAIL=${{ vars.MAX_ATTEMPTS_PER_EMAIL }}" >> .env
          echo "MAX_ATTEMPTS_PER_IP=${{ vars.MAX_ATTEMPTS_PER_IP }}" >> .env
          echo "PASSWORD_RESET_TOKEN_EXPIRE_MINUTES=${{ vars.PASSWORD_RESET_TOKEN_EXPIRE_MINUTES }}" >> .env
          echo "REFRESH_TOKEN_EXPIRE_DAYS=${{ vars.REFRESH_TOKEN_EXPIRE_DAYS }}" >> .env
          echo "WINDOW_HOURS=${{ vars.WINDOW_HOURS }}" >> .env
          echo "ALGORITHM=${{ vars.ALGORITHM }}" >> .env
          echo "ACCESS_TOKEN_EXPIRE_MINUTES=${{ vars.ACCESS_TOKEN_EXPIRE_MINUTES }}" >> .env
          echo "GOOGLE_CLIENT_ID=${{ vars.GOOGLE_CLIENT_ID }}" >> .env
          echo "AT_USERNAME=${{ vars.AT_USERNAME }}" >> .env
          echo "AT_ENV=${{ vars.AT_ENV }}" >> .env
          echo "AT_SENDER_ID=" >> .env
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run tests
        run: |
          pytest tests/ --tb=short -q
      
      # Add your deployment step here (Railway, Render, AWS, etc.)
      # Example for Railway:
      # - name: Deploy to Railway
      #   env:
      #     RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      #   run: |
      #     npm i -g @railway/cli
      #     railway up --service medication-api
